#' Function to get table 1 summary for MISC patients during the MISC hospitalization

#' Given the \code{data.frame} output generated by the \code{format_data_for_stats} function
#' generates as output the table 1 for the manuscript
#'
#' @param formated_df The data.frame generated by the \code{format_data_for_stats} function.
#' @param obfuscation_threshold FALSE if no obfuscation is needed, the numeric value when there is obfuscation
#' @param currSiteId Site ID
#' @param dir.output The path to the output directory where the aggregate counts and plots will be saved.
#' @param verbose By default \code{FALSE}. Change it to \code{TRUE} to get an on-time log from the function.
#' @return Table 1 for the manuscript.
#' @examples
#'
#' t1 <- misc_table1(
#'               formated_df,
#'               currSiteID,
#'               dir.output,
#'               verbose
#'              )
#' @export misc_table1
#'
misc_table1 <- function(complete_df, obfuscation_threshold, currSiteId, dir.output, verbose, raceAvailable){

  clinicalChar <- read.delim('inst/extdata/clinicalCharacteristics.txt')
  total_n_patients <- length(unique(complete_df$patient_num))

  # insert race
  if( raceAvailable == TRUE ){
    race_raw <- read.delim(file.path(dir.input, "/LocalPatientRace.csv"), sep = ",", skip = 0)
    complete_df <- left_join( complete_df, race_raw %>% select( patient_num, race_4ce), by="patient_num")
  }

  # filter complete_df to include the clinical characteristics of interest
  df <- complete_df %>%
    filter(concept_code %in% clinicalChar$concept_code)

  # merge clinicalChar so we have the names and categories for each code
  df <- left_join(df, clinicalChar, by = 'concept_code')

  # demographics summaries IF sites have race available
  if (raceAvailable == TRUE) {
    race_summary <- df %>%
      group_by(variant_misc) %>%
      mutate(total_n = n_distinct(patient_num)) %>%
      group_by(race_4ce, variant_misc) %>%
      summarise(n = n_distinct(patient_num),
                perc = (n / total_n) * 100) %>%
      unique() %>%
      rename(variableName = race_4ce)
  } else {
    race_summary <- data.frame(variableName = '', variant_misc = '', n = '', perc = '')
    race_summary <- race_summary[-1,]
  }


  # summarise by category
  category_summary <- df %>%
    group_by(variant_misc) %>%
    mutate(total_n = n_distinct(patient_num)) %>%
    group_by(category, variant_misc) %>%
    summarise(n = n_distinct(patient_num),
             perc = (n / total_n) * 100) %>%
    unique()

  # summarise by code
  concept_summary <- df %>%
    group_by(variant_misc) %>%
    mutate(total_n = n_distinct(patient_num)) %>%
    group_by(variableName, variant_misc) %>%
    summarise(n = n_distinct(patient_num),
              perc = (n / total_n) * 100) %>%
    unique()

  # combine
  colnames(category_summary)[1] <- 'variableName'
  df2 <- rbind(race_summary, category_summary, concept_summary)

  # ordered list for table based on sample table 1 sent by francesca
  ordered_rows <- c('age', 'sex',
                    'race_4ce', 'white', 'black', 'asian', 'american_indian', 'other', 'no_information',
                    'overweight', 'obesity',
                    'fatigue', 'rash',
                    'GI symptoms', 'abdominal pain', 'nausea', 'vomiting', 'diarrhea_enteritis_ileitis', 'apendicitis_peritonitis',
                    'Respiratory symptoms', 'cough', 'rhinitis rhinorrhea', 'sore throat', 'tachypnea', 'dyspnea_shortness of breath',
                    'Cardiovascular symptoms', 'chest pain', 'palpitations', 'lower extremety edema', 'pre-syncope_syncope','ventricular dysfunction', 'heart failure', 'shock',
                    'Neurologic symptoms', 'headache', 'confusion', 'irritability', 'seizures', 'muscle weakness', 'encephalopathy', 'meningoencephalitis', 'lethargy', 'stroke',
                    'Renal involvement', 'renal dysfunction', 'acute renal failure',
                    'Liver involvement', 'hepatitis', 'liver dysfunction', 'acute liver failure',
                    'Kawasaki')
  other_rows <- df2$variableName[!df2$variableName %in% ordered_rows] %>% unique()

  # reorder combined df
  df2 <- df2 %>%
    mutate(variableName =  factor(variableName, levels = c(ordered_rows, other_rows))) %>%
    arrange(variableName) %>%
    group_by(variableName) %>%
    mutate(total_n = paste0(sum(n), ' (', round(sum(n) / total_n_patients, digits = 2) * 100, '%)'))

  # pivot df with combined n / percentage cells
  df3 <- df2 %>%
    mutate(n_perc = paste0(n, ' (', round(perc, digits = 2), '%)')) %>%
    select(-n, -perc) %>%
    pivot_wider(names_from = variant_misc, values_from = n_perc, values_fill = '0 (0%)')

  # add in continuous variables
  continuous_summary <- df %>%
    select(patient_num, age, len_hospitalisation, variant_misc) %>%
    rename(orig_age = age,
           orig_len_hosp = len_hospitalisation) %>%
    group_by(variant_misc) %>%
    unique() %>%
    summarise(age = paste0('median: ', median(orig_age),
                           ', IQR: (', round(IQR(orig_age), digits = 2),
                           '), min,max: [', min(orig_age), ',', max(orig_age),
                           '], mean= ', round(mean(orig_age), digits = 2),
                           ', SD=', round(sd(orig_age), digits = 2)),
              length_hospitalization = paste0('median: ', median(orig_len_hosp),
                                              ', IQR: (', round(IQR(orig_len_hosp), digits = 2),
                                              '), min,max: [', min(orig_len_hosp), ',', max(orig_len_hosp),
                                              '], mean= ', round(mean(orig_len_hosp), digits = 2),
                                              ', SD=', round(sd(orig_len_hosp), digits = 2))) %>%
    t() %>%
    as.data.frame()
  colnames(continuous_summary) <- continuous_summary[1,]
  continuous_summary$variableName <- rownames(continuous_summary)
  rownames(continuous_summary) <- NULL
  continuous_summary <- continuous_summary[-1,]

  # find totals of the continuous variables
  continuous_total_summary <- df %>%
    select(patient_num, age, len_hospitalisation) %>%
    rename(orig_age = age,
           orig_len_hosp = len_hospitalisation) %>%
    unique() %>%
    summarise(age = paste0('median: ', median(orig_age),
                           ', IQR: (', round(IQR(orig_age), digits = 2),
                           '), min,max: [', min(orig_age), ',', max(orig_age),
                           '], mean= ', round(mean(orig_age), digits = 2),
                           ', SD=', round(sd(orig_age), digits = 2)),
              length_hospitalization = paste0('median: ', median(orig_len_hosp),
                                              ', IQR: (', round(IQR(orig_len_hosp), digits = 2),
                                              '), min,max: [', min(orig_len_hosp), ',', max(orig_len_hosp),
                                              '], mean= ', round(mean(orig_len_hosp), digits = 2),
                                              ', SD=', round(sd(orig_len_hosp), digits = 2))) %>%
    t() %>%
    as.data.frame()
  colnames(continuous_total_summary) <- 'total_n'
  continuous_total_summary$variableName <- rownames(continuous_total_summary)
  rownames(continuous_total_summary) <- NULL

  continuous_summary <- left_join(continuous_summary, continuous_total_summary)

  df4 <- rbind(continuous_summary, df3) %>%
    select(variableName, total_n, everything())

  return(df4)



}


